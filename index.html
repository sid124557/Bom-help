<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM Studio</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #f5f4f0;
  --surface: #ffffff;
  --surface2: #f0efe9;
  --surface3: #e8e7e0;
  --border: #dddbd2;
  --border2: #c8c6bc;
  --text: #1a1916;
  --text2: #5a5850;
  --text3: #9a9890;
  --accent: #2563a8;
  --accent-bg: #eff4fc;
  --accent-border: #bdd0ef;
  --green: #16803c;
  --green-bg: #f0faf4;
  --green-border: #a7d9b8;
  --red: #c0392b;
  --red-bg: #fdf2f1;
  --red-border: #f0b8b2;
  --amber: #b45309;
  --amber-bg: #fffbeb;
  --amber-border: #f0d58a;
  --halb: #7c3aed;
  --halb-bg: #f5f0ff;
  --roh: #0e7490;
  --roh-bg: #f0f9ff;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
  --radius: 8px;
  --radius-sm: 5px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app { display: flex; flex-direction: column; min-height: 100vh; }

.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.logo {
  font-family: 'DM Mono', monospace;
  font-weight: 500;
  font-size: 15px;
  color: var(--text);
  letter-spacing: -0.03em;
  white-space: nowrap;
}
.logo span { color: var(--accent); }

.topbar-sep { width: 1px; height: 28px; background: var(--border); }

.tabs { display: flex; gap: 2px; }
.tab {
  padding: 6px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  color: var(--text2);
  cursor: pointer;
  border: none;
  background: transparent;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab:hover { background: var(--surface2); color: var(--text); }
.tab.active { background: var(--accent-bg); color: var(--accent); }
.tab .badge {
  display: inline-block;
  margin-left: 6px;
  background: var(--red);
  color: white;
  font-size: 10px;
  font-weight: 600;
  padding: 1px 5px;
  border-radius: 10px;
  vertical-align: middle;
}

.topbar-right { margin-left: auto; display: flex; gap: 8px; align-items: center; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 500;
  padding: 7px 14px;
  border-radius: var(--radius-sm);
  border: 1px solid transparent;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.12s;
}
.btn svg { flex-shrink: 0; }
.btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
.btn-primary:hover { background: #1e52a0; }
.btn-secondary { background: var(--surface); color: var(--text); border-color: var(--border2); }
.btn-secondary:hover { background: var(--surface2); border-color: var(--border2); }
.btn-ghost { background: transparent; color: var(--text2); border-color: transparent; }
.btn-ghost:hover { background: var(--surface2); color: var(--text); }
.btn-green { background: var(--green); color: white; border-color: var(--green); }
.btn-green:hover { background: #126833; }
.btn-red { background: var(--red); color: white; border-color: var(--red); }
.btn-red:hover { background: #a03122; }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
.page { display: none; padding: 24px; }
.page.active { display: block; }

/* ‚îÄ‚îÄ Import page ‚îÄ‚îÄ */
.import-layout {
  max-width: 100%;
}

.import-top {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 16px;
  margin-bottom: 20px;
}

@media (max-width: 900px) {
  .import-top { grid-template-columns: 1fr; }
}

.import-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  margin-bottom: 20px;
}

.card-header {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface2);
}

.card-header h3 { font-size: 13px; font-weight: 600; }
.card-header .hint { margin-left: auto; font-size: 11px; color: var(--text3); }

.step-num {
  width: 22px; height: 22px;
  background: var(--accent);
  color: white;
  border-radius: 50%;
  font-size: 11px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

textarea.paste-area {
  width: 100%;
  height: 260px;
  border: none;
  outline: none;
  padding: 16px 20px;
  font-family: 'DM Mono', monospace;
  font-size: 11.5px;
  line-height: 1.7;
  color: var(--text);
  background: var(--surface);
  resize: vertical;
}
textarea.paste-area::placeholder { color: var(--text3); }

.import-actions {
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  align-items: center;
  background: var(--surface2);
}

.col-map {
  padding: 16px 20px;
  display: grid;
  grid-template-columns: 1fr 24px 1fr;
  gap: 6px 8px;
  align-items: center;
  font-size: 12px;
}
.col-from { color: var(--accent); font-family: 'DM Mono', monospace; font-size: 11px; }
.col-arr { color: var(--text3); text-align: center; }
.col-to { color: var(--text2); }
.col-note { grid-column: 3; color: var(--green); font-size: 10px; }

/* ‚îÄ‚îÄ BOM Editor ‚îÄ‚îÄ */
.editor-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 14px;
  flex-wrap: wrap;
}

.group-nav {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}
.group-pill {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  border: 1px solid var(--border2);
  background: var(--surface);
  cursor: pointer;
  transition: all 0.12s;
  font-family: 'DM Mono', monospace;
}
.group-pill:hover { border-color: var(--accent); color: var(--accent); }
.group-pill.active { background: var(--accent); color: white; border-color: var(--accent); }
.group-pill.has-changes { border-color: var(--amber); }
.group-pill.active.has-changes { background: var(--amber); border-color: var(--amber); }

.bom-table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.bom-group {
  display: none;
}
.bom-group.active { display: block; }

.group-header-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--surface2);
  border-bottom: 2px solid var(--border);
}

.group-title { font-weight: 600; font-size: 13px; font-family: 'DM Mono', monospace; }
.group-desc { font-size: 12px; color: var(--text2); }
.group-meta { margin-left: auto; font-size: 11px; color: var(--text3); display: flex; gap: 12px; }

table.bom-tbl { width: 100%; border-collapse: collapse; }

table.bom-tbl thead th {
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text3);
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  text-align: left;
  white-space: nowrap;
  position: sticky;
  top: 56px;
  z-index: 5;
}

table.bom-tbl tbody td {
  padding: 0;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

table.bom-tbl tbody tr:last-child td { border-bottom: none; }
table.bom-tbl tbody tr:hover td { background: #fafaf8; }

table.bom-tbl tbody tr.row-added td { background: var(--green-bg) !important; }
table.bom-tbl tbody tr.row-deleted td { background: var(--red-bg) !important; opacity: 0.6; text-decoration: line-through; pointer-events: none; }
table.bom-tbl tbody tr.row-modified td { background: var(--amber-bg) !important; }

.cell-input {
  width: 100%;
  padding: 7px 10px;
  border: none;
  outline: none;
  background: transparent;
  font-family: 'DM Mono', monospace;
  font-size: 11.5px;
  color: var(--text);
  min-width: 60px;
}
.cell-input:focus { background: var(--accent-bg); }
.cell-input.changed { color: var(--amber); font-weight: 500; }

select.cell-select {
  width: 100%;
  padding: 7px 10px;
  border: none;
  outline: none;
  background: transparent;
  font-family: 'DM Mono', monospace;
  font-size: 11.5px;
  color: var(--text);
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
}
select.cell-select:focus { background: var(--accent-bg); }

.type-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.05em;
}
.type-halb { background: var(--halb-bg); color: var(--halb); }
.type-roh  { background: var(--roh-bg); color: var(--roh); }

.row-actions { display: flex; gap: 4px; padding: 4px 8px; }
.row-btn {
  width: 26px; height: 26px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  background: transparent;
  color: var(--text3);
  transition: all 0.12s;
}
.row-btn:hover { background: var(--surface3); color: var(--text); }
.row-btn.del:hover { background: var(--red-bg); color: var(--red); }
.row-btn.restore:hover { background: var(--green-bg); color: var(--green); }
.row-btn.goto-child {
  width: auto;
  padding: 0 8px;
  font-size: 10px;
  font-weight: 600;
  font-family: 'DM Mono', monospace;
  color: var(--halb);
  border: 1px solid var(--halb-bg);
  background: var(--halb-bg);
  border-radius: 4px;
  gap: 3px;
  white-space: nowrap;
}
.row-btn.goto-child:hover { background: var(--halb); color: white; border-color: var(--halb); }
.row-btn.goto-child.missing { color: var(--text3); background: var(--surface2); border-color: var(--border); font-style: italic; }
.row-btn.goto-child.missing:hover { background: var(--surface3); color: var(--text); }

.add-row-btn {
  width: 100%;
  padding: 9px;
  border: none;
  background: transparent;
  color: var(--text3);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  border-top: 1px dashed var(--border2);
  transition: all 0.12s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.add-row-btn:hover { background: var(--green-bg); color: var(--green); }

/* ‚îÄ‚îÄ Diff page ‚îÄ‚îÄ */
.diff-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }

.diff-legend { display: flex; gap: 14px; font-size: 12px; }
.diff-legend-item { display: flex; align-items: center; gap: 6px; }
.diff-dot { width: 10px; height: 10px; border-radius: 3px; }
.diff-dot-added { background: var(--green); }
.diff-dot-removed { background: var(--red); }
.diff-dot-modified { background: var(--amber); }
.diff-dot-unchanged { background: var(--border2); }

.diff-summary {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.diff-stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}
.diff-stat-num { font-size: 22px; font-weight: 700; font-family: 'DM Mono', monospace; line-height: 1; }
.diff-stat-num.green { color: var(--green); }
.diff-stat-num.red { color: var(--red); }
.diff-stat-num.amber { color: var(--amber); }
.diff-stat-num.muted { color: var(--text3); }
.diff-stat-label { color: var(--text2); font-size: 11px; }

.diff-group { margin-bottom: 20px; }
.diff-group-title {
  font-size: 12px;
  font-weight: 600;
  font-family: 'DM Mono', monospace;
  color: var(--text2);
  padding: 8px 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.diff-table-wrap {
  border: 1px solid var(--border);
  border-radius: 0 0 var(--radius-sm) var(--radius-sm);
  overflow: hidden;
  overflow-x: auto;
}

table.diff-tbl { width: 100%; border-collapse: collapse; font-size: 11.5px; white-space: nowrap; }
table.diff-tbl th {
  padding: 7px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text3);
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  text-align: left;
}
table.diff-tbl td {
  padding: 7px 12px;
  border-bottom: 1px solid var(--border);
  font-family: 'DM Mono', monospace;
}
table.diff-tbl tr:last-child td { border-bottom: none; }

tr.diff-added td { background: var(--green-bg); }
tr.diff-added td:first-child { border-left: 3px solid var(--green); }
tr.diff-removed td { background: var(--red-bg); }
tr.diff-removed td:first-child { border-left: 3px solid var(--red); }
tr.diff-modified td { background: var(--amber-bg); }
tr.diff-modified td:first-child { border-left: 3px solid var(--amber); }
tr.diff-unchanged td { color: var(--text3); }

.diff-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 700;
  font-family: 'DM Mono', monospace;
}
.diff-tag-added { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.diff-tag-removed { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.diff-tag-modified { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
.diff-tag-unchanged { background: var(--surface2); color: var(--text3); border: 1px solid var(--border); }

.cell-old { color: var(--red); text-decoration: line-through; margin-right: 4px; }
.cell-new { color: var(--green); }

/* ‚îÄ‚îÄ Import stats bar ‚îÄ‚îÄ */
.import-stats {
  display: none;
  gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
  margin-bottom: 16px;
}
.import-stats.visible { display: flex; flex-wrap: wrap; }
.istat {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 20px;
  border-right: 1px solid var(--border);
  min-width: 100px;
}
.istat:last-child { border-right: none; }
.istat-val {
  font-family: 'DM Mono', monospace;
  font-size: 22px;
  font-weight: 500;
  color: var(--accent);
  line-height: 1;
  margin-bottom: 4px;
}
.istat-val.green { color: var(--green); }
.istat-val.purple { color: var(--halb); }
.istat-val.red { color: var(--red); }
.istat-key {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text3);
}

/* ‚îÄ‚îÄ Import output table ‚îÄ‚îÄ */
.import-output {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  margin-bottom: 20px;
}
.import-output.visible { display: block; }
.import-output-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
}
.import-output-header h3 { font-size: 13px; font-weight: 600; }
.import-output-actions { margin-left: auto; display: flex; gap: 8px; }
.output-table-wrap {
  overflow-x: auto;
  max-height: 520px;
  overflow-y: auto;
}
table.output-tbl { width: 100%; border-collapse: collapse; font-size: 11.5px; white-space: nowrap; }
table.output-tbl thead th {
  padding: 8px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text3);
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  text-align: left;
  position: sticky;
  top: 0;
  z-index: 3;
}
table.output-tbl tbody td {
  padding: 7px 12px;
  border-bottom: 1px solid var(--border);
  font-family: 'DM Mono', monospace;
  color: var(--text2);
}
table.output-tbl tbody tr:last-child td { border-bottom: none; }
table.output-tbl tbody tr:hover td { background: var(--surface2); }
table.output-tbl tbody tr.sep-row td {
  background: var(--surface2);
  color: var(--text3);
  font-style: italic;
  font-size: 10px;
  text-align: center;
  padding: 5px 12px;
  border-top: 1px solid var(--border);
}
.tbl-num { color: var(--text3); }
.tbl-mat { color: var(--accent); font-weight: 500; }
.tbl-comp { color: var(--text); font-weight: 500; }
.tbl-halb { color: var(--halb); font-weight: 600; }
.tbl-roh  { color: var(--roh); font-weight: 600; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--text);
  color: white;
  padding: 10px 18px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.2s ease;
  pointer-events: none;
  z-index: 999;
  box-shadow: var(--shadow);
}
#toast.show { opacity: 1; transform: translateY(0); }
#toast.ok { background: var(--green); }
#toast.err { background: var(--red); }

/* ‚îÄ‚îÄ Empty states ‚îÄ‚îÄ */
.empty {
  text-align: center;
  padding: 60px 24px;
  color: var(--text3);
}
.empty-icon { font-size: 40px; margin-bottom: 12px; }
.empty h3 { font-size: 15px; font-weight: 600; color: var(--text2); margin-bottom: 6px; }
.empty p { font-size: 13px; }

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--surface2); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }
</style>
</head>
<body>
<div class="app">

<!-- Top Bar -->
<div class="topbar">
  <div class="logo">BOM<span>Studio</span></div>
  <div class="topbar-sep"></div>
  <div class="tabs">
    <button class="tab active" data-page="import" onclick="switchPage('import')">‚ë† Import</button>
    <button class="tab" data-page="editor" onclick="switchPage('editor')">‚ë° Edit BOM</button>
    <button class="tab" data-page="diff" onclick="switchPage('diff')">‚ë¢ Compare Changes <span class="badge" id="diffBadge" style="display:none">!</span></button>
  </div>
  <div class="topbar-right">
    <button class="btn btn-secondary" id="btnExportTSV" onclick="exportTSV()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export for Excel
    </button>
  </div>
</div>

<!-- ‚ë† Import Page -->
<div class="page active" id="page-import">
<div class="import-layout">

  <!-- Top: paste area + column reference side by side -->
  <div class="import-top">
    <div class="import-card">
      <div class="card-header">
        <div class="step-num">1</div>
        <h3>Paste Sheet 1 Data</h3>
        <span class="hint">Include the header row ¬∑ Tab-separated from SAP/Excel</span>
      </div>
      <textarea class="paste-area" id="pasteArea" placeholder="Paste your Sheet 1 BOM data here (with header row)...

Expected columns:
Plant | Level | Material | Material Description | Component | Component Description | Comp.Qty(CUn) | Comp.Qty(BUn) | UOM | Material Type | Alternative BOM | Base Unit of Measure | BasQty(Next Level) | ..."></textarea>
      <div class="import-actions">
        <button class="btn btn-primary" onclick="importBOM()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
          Import & Build BOM
        </button>
        <button class="btn btn-ghost" onclick="clearImport()">Clear</button>
      </div>
    </div>

    <div class="import-card">
      <div class="card-header">
        <div class="step-num" style="background:var(--text3)">?</div>
        <h3>Column Mapping Reference</h3>
      </div>
      <div class="col-map">
        <span class="col-from">Col 0 ‚Äî Plant</span><span class="col-arr">‚Üí</span><span class="col-to">Plant (5600 or 5500 ‚Üí "5500/5600")</span>
        <span class="col-from">Col 1 ‚Äî Level</span><span class="col-arr">‚Üí</span><span class="col-to">Drives parent hierarchy (1‚Üí2‚Üí3‚Ä¶)</span>
        <span class="col-from">Col 2 ‚Äî Material</span><span class="col-arr">‚Üí</span><span class="col-to">Material number</span>
        <span class="col-from">Col 3 ‚Äî Material Description</span><span class="col-arr">‚Üí</span><span class="col-to">Material Description</span>
        <span class="col-from">Col 4 ‚Äî Component</span><span class="col-arr">‚Üí</span><span class="col-to">Component number</span>
        <span class="col-from">Col 5 ‚Äî Component Description</span><span class="col-arr">‚Üí</span><span class="col-to">Component Description</span>
        <span class="col-from">Col 6 ‚Äî Comp. Qty(CUn)</span><span class="col-arr">‚Üí</span><span class="col-to">Quantity <em>(Sheet 2)</em></span>
        <span class="col-from">Col 8 ‚Äî UOM</span><span class="col-arr">‚Üí</span><span class="col-to">Component unit</span>
        <span class="col-from">Col 9 ‚Äî Material Type</span><span class="col-arr">‚Üí</span><span class="col-to">Material Type (ROH / HALB)</span>
        <span class="col-from">Col 10 ‚Äî Alternative BOM</span><span class="col-arr">‚Üí</span><span class="col-to">Alternative</span>
        <span class="col-from">Col 12 ‚Äî BasQty (Next Level)</span><span class="col-arr">‚Üí</span><span class="col-to">Base quantity</span>
        <span class="col-note">Usage = 1 ¬∑ Alt Text = blank ¬∑ Prod.Stor.Loc = blank ¬∑ Duplicates auto-removed</span>
      </div>
    </div>
  </div>

  <!-- Stats bar ‚Äî shown after import -->
  <div class="import-stats" id="importStats">
    <div class="istat"><div class="istat-val" id="iIn">0</div><div class="istat-key">Input Rows</div></div>
    <div class="istat"><div class="istat-val" id="iOut">0</div><div class="istat-key">Output Rows</div></div>
    <div class="istat"><div class="istat-val" id="iPar">0</div><div class="istat-key">Parent Groups</div></div>
    <div class="istat"><div class="istat-val red" id="iDup">0</div><div class="istat-key">Duplicates Removed</div></div>
    <div class="istat"><div class="istat-val green" id="iRoh">0</div><div class="istat-key">ROH</div></div>
    <div class="istat"><div class="istat-val purple" id="iHalb">0</div><div class="istat-key">HALB</div></div>
  </div>

  <!-- Sheet 2 output table ‚Äî shown after import -->
  <div class="import-output" id="importOutput">
    <div class="import-output-header">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);flex-shrink:0"></div>
      <h3>Sheet 2 Output</h3>
      <span style="font-size:11px;color:var(--text3)" id="importRowCount"></span>
      <div class="import-output-actions">
        <button class="btn btn-secondary btn-sm" onclick="importCopyTSV()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Copy for Excel
        </button>
        <button class="btn btn-secondary btn-sm" onclick="importDownloadCSV()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download CSV
        </button>
      </div>
    </div>
    <div class="output-table-wrap">
      <table class="output-tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Material</th>
            <th>Material Description</th>
            <th>Plant</th>
            <th>Usage</th>
            <th>Alternative</th>
            <th>Base Qty</th>
            <th>Component</th>
            <th>Component Description</th>
            <th>Material Type</th>
            <th>Alt Text</th>
            <th>Quantity</th>
            <th>Component Unit</th>
            <th>Prod.Stor.Loc.</th>
          </tr>
        </thead>
        <tbody id="importTableBody"></tbody>
      </table>
    </div>
  </div>

</div>
</div>

<!-- ‚ë° Editor Page -->
<div class="page" id="page-editor">

  <div id="editorEmpty" class="empty">
    <div class="empty-icon">üìã</div>
    <h3>No BOM loaded</h3>
    <p>Go to Import and paste your Sheet 1 data to get started.</p>
  </div>

  <div id="editorContent" style="display:none">
    <div class="editor-toolbar">
      <span style="font-size:13px; font-weight:600; color:var(--text2)">Parent Groups</span>
      <span style="font-size:12px; color:var(--text3)" id="groupCount"></span>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn btn-secondary btn-sm" onclick="addNewGroup()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Group
        </button>
        <button class="btn btn-green btn-sm" onclick="runDiff(); switchPage('diff')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/></svg>
          View Changes
        </button>
      </div>
    </div>

    <div class="group-nav" id="groupNav"></div>

    <div class="bom-table-wrap">
      <div id="groupsContainer"></div>
    </div>
  </div>

</div>

<!-- ‚ë¢ Diff Page -->
<div class="page" id="page-diff">

  <div id="diffEmpty" class="empty">
    <div class="empty-icon">üîç</div>
    <h3>No comparison yet</h3>
    <p>Import a BOM and make edits, then come back here to see changes.</p>
  </div>

  <div id="diffContent" style="display:none">
    <div class="diff-toolbar">
      <span style="font-size:13px; font-weight:600">Changes vs. Original BOM</span>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div class="diff-legend">
          <div class="diff-legend-item"><div class="diff-dot diff-dot-added"></div><span>Added</span></div>
          <div class="diff-legend-item"><div class="diff-dot diff-dot-removed"></div><span>Removed</span></div>
          <div class="diff-legend-item"><div class="diff-dot diff-dot-modified"></div><span>Modified</span></div>
          <div class="diff-legend-item"><div class="diff-dot diff-dot-unchanged"></div><span>Unchanged</span></div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportDiffCSV()">Export Diff CSV</button>
        <button class="btn btn-green btn-sm" onclick="exportExcel()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Download Excel (.xlsx)
        </button>
      </div>
    </div>

    <div class="diff-summary" id="diffSummary"></div>
    <div id="diffOutput"></div>
  </div>

</div>

</div><!-- end .app -->

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let originalGroups = null;  // frozen after import ‚Äî never mutated
let editedGroups   = null;  // live editable copy

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARSING ‚Äî exact logic from BOM Converter v2
// Column indices (0-based):
// Plant(0) | Level(1) | Material(2) | MatDesc(3) | Component(4) | CompDesc(5)
// Comp.Qty(CUn)(6) | Comp.Qty(BUn)(7) | UOM(8) | MatType(9) | AltBOM(10)
// BaseUoM(11) | BasQty(12) | ...
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const C = {
  PLANT:0, LEVEL:1, MATERIAL:2, MAT_DESC:3,
  COMPONENT:4, COMP_DESC:5,
  QTY_CUN:6,   // Comp. Qty(CUn) ‚Äî used as "Quantity" in Sheet 2
  QTY_BUN:7,
  UOM:8,
  MAT_TYPE:9,
  ALT_BOM:10,
  BASE_QTY:12
};

function g(cells, idx) { return (cells[idx] || '').trim(); }
function parsePlant(raw) {
  const p = raw.trim();
  if (p === '5600') return '5500/5600';
  if (p === '5500') return '5500/5600';
  return p;
}

function parseSheet1(raw) {
  const lines = raw.split('\n').map(l => l.trimEnd()).filter(l => l.trim());
  if (lines.length < 2) throw new Error('Need at least a header row + 1 data row.');

  const sep = lines[0].includes('\t') ? '\t' : '|';
  const dataLines = lines.slice(1);

  // ‚îÄ‚îÄ First pass: find top-level material ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let topMaterial = '', topMatDesc = '', topPlant = '', topAlt = '1';
  for (const line of dataLines) {
    const cells = line.split(sep);
    if (cells.length < 10) continue;
    if (g(cells, C.LEVEL) === '1') {
      topMaterial = g(cells, C.MATERIAL);
      topMatDesc  = g(cells, C.MAT_DESC);
      topPlant    = parsePlant(g(cells, C.PLANT));
      topAlt      = g(cells, C.ALT_BOM) || '1';
      break;
    }
  }
  if (!topMaterial) throw new Error('Could not find any Level 1 rows. Check your data.');

  // parentStack[level] = { material, matDesc, plant, alt }
  // parentStack[0] = the main finished-good material (parent for level-1 rows)
  const parentStack = {};
  parentStack[0] = { material: topMaterial, matDesc: topMatDesc, plant: topPlant, alt: topAlt };

  // groups: plain object keyed by parent material (preserves insertion order)
  // Each group: { matDesc, plant, alt, children: [{id, component, compDesc, matType, qty, uom, baseQty}] }
  const groups = {};
  const seenKey = new Set();   // deduplication: "parentMat||component"
  let dupes = 0;
  let inputCount = 0;
  let uid = 0;

  // ‚îÄ‚îÄ Second pass: assign each row to correct parent via parentStack ‚îÄ‚îÄ
  for (const line of dataLines) {
    const cells = line.split(sep);
    if (cells.length < 10) continue;

    const level     = parseInt(g(cells, C.LEVEL)) || 0;
    const material  = g(cells, C.MATERIAL);
    const matDesc   = g(cells, C.MAT_DESC);
    const component = g(cells, C.COMPONENT);
    const compDesc  = g(cells, C.COMP_DESC);
    const matType   = g(cells, C.MAT_TYPE);
    const qtyCun    = g(cells, C.QTY_CUN);
    const uom       = g(cells, C.UOM);
    const baseQty   = g(cells, C.BASE_QTY) || '1,000';
    const plant     = parsePlant(g(cells, C.PLANT));
    const altBom    = g(cells, C.ALT_BOM) || '1';

    if (!component) continue;
    inputCount++;

    // Parent lives one level up in the stack
    const parentLevel = level - 1;
    const parent = parentStack[parentLevel];
    if (!parent) continue; // orphan row ‚Äî skip

    const parentMat = parent.material;

    // Deduplicate: same parent + same component = skip
    const dedupKey = `${parentMat}||${component}`;
    if (seenKey.has(dedupKey)) {
      dupes++;
    } else {
      seenKey.add(dedupKey);
      if (!groups[parentMat]) {
        groups[parentMat] = { matDesc: parent.matDesc, plant: parent.plant, alt: parent.alt, children: [] };
      }
      groups[parentMat].children.push({
        id: 'r' + (++uid),
        component, compDesc, matType,
        qty: qtyCun, uom, baseQty
      });
    }

    // Always update the stack so children of this row know their parent
    parentStack[level] = { material: component, matDesc: compDesc, plant, alt: altBom };

    // Handle multiple top-level materials in one paste
    if (level === 1 && material !== topMaterial) {
      topMaterial = material;
      topMatDesc  = matDesc;
      parentStack[0] = { material: topMaterial, matDesc: topMatDesc, plant, alt: altBom };
    }
  }

  // Convert plain object groups ‚Üí Map (for Studio compatibility) and attach stats
  const groupsMap = new Map();
  for (const [key, grp] of Object.entries(groups)) {
    groupsMap.set(key, {
      matDesc: grp.matDesc,
      plant:   grp.plant,
      alt:     grp.alt,
      rows:    grp.children   // renamed to 'rows' for Studio
    });
  }

  // Attach parse stats onto the Map so importBOM can surface them
  groupsMap._stats = { inputCount, dupes };
  return groupsMap;
}

// Deep clone groups map
function cloneGroups(groups) {
  const out = new Map();
  groups.forEach((g,k) => {
    out.set(k, {
      matDesc: g.matDesc,
      plant: g.plant,
      alt: g.alt,
      rows: g.rows.map(r => ({...r}))
    });
  });
  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _uidCounter = 10000;
function newId() { return 'r'+(++_uidCounter); }

// Flat ordered list of all output rows for the import table
let importFlatRows = [];

const SHEET2_HEADERS = ['Material','Material Description','Plant','Usage','Alternative','Base quantity','Component','Component Description','Material Type','Alt Text','Quantity','Component unit','Prod. Stor.Loc.'];

function importBOM() {
  const raw = document.getElementById('pasteArea').value.trim();
  if (!raw) { toast('Paste Sheet 1 data first.','err'); return; }
  try {
    const groups = parseSheet1(raw);
    const stats = groups._stats || {};
    delete groups._stats;

    originalGroups = groups;
    editedGroups   = cloneGroups(groups);

    // ‚îÄ‚îÄ Build flat rows for the import table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    importFlatRows = [];
    groups.forEach((g, parentMat) => {
      g.rows.forEach(r => {
        importFlatRows.push({ parentMat, matDesc: g.matDesc, plant: g.plant, alt: g.alt, ...r });
      });
    });

    // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const roh  = importFlatRows.filter(r => r.matType === 'ROH').length;
    const halb = importFlatRows.filter(r => r.matType === 'HALB').length;
    document.getElementById('iIn').textContent   = stats.inputCount || importFlatRows.length;
    document.getElementById('iOut').textContent  = importFlatRows.length;
    document.getElementById('iPar').textContent  = groups.size;
    document.getElementById('iDup').textContent  = stats.dupes || 0;
    document.getElementById('iRoh').textContent  = roh;
    document.getElementById('iHalb').textContent = halb;
    document.getElementById('importStats').classList.add('visible');

    // ‚îÄ‚îÄ Render table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderImportTable(importFlatRows);
    document.getElementById('importRowCount').textContent = importFlatRows.length + ' rows ¬∑ ' + groups.size + ' groups';
    document.getElementById('importOutput').classList.add('visible');
    document.getElementById('importOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // ‚îÄ‚îÄ Ready editor & export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderEditor();
    document.getElementById('btnExportTSV').style.display = '';
    updateDiffBadge();

    const dupeNote = stats.dupes > 0 ? ` ¬∑ ${stats.dupes} duplicates removed` : '';
    toast(`Imported ${stats.inputCount} rows ‚Üí ${groups.size} parent groups${dupeNote}`, 'ok');
  } catch(e) {
    toast('Error: '+e.message, 'err');
    console.error(e);
  }
}

function renderImportTable(rows) {
  const tbody = document.getElementById('importTableBody');
  tbody.innerHTML = '';
  let lastParent = null;
  let n = 0;
  rows.forEach(r => {
    if (r.parentMat !== lastParent && lastParent !== null) {
      const sep = document.createElement('tr');
      sep.className = 'sep-row';
      sep.innerHTML = `<td colspan="14">‚îÄ‚îÄ next parent group ‚îÄ‚îÄ</td>`;
      tbody.appendChild(sep);
    }
    lastParent = r.parentMat;
    n++;
    const tc = r.matType === 'HALB' ? 'tbl-halb' : r.matType === 'ROH' ? 'tbl-roh' : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="tbl-num">${n}</td>
      <td class="tbl-mat">${esc(r.parentMat)}</td>
      <td>${esc(r.matDesc)}</td>
      <td>${esc(r.plant)}</td>
      <td style="text-align:center">1</td>
      <td style="text-align:center">${esc(r.alt)}</td>
      <td style="text-align:right">1000</td>
      <td class="tbl-comp">${esc(r.component)}</td>
      <td>${esc(r.compDesc)}</td>
      <td class="${tc}">${esc(r.matType)}</td>
      <td></td>
      <td style="text-align:right">${esc(r.qty)}</td>
      <td>${esc(r.uom)}</td>
      <td></td>
    `;
    tbody.appendChild(tr);
  });
}

function importCopyTSV() {
  if (!importFlatRows.length) return;
  const lines = [SHEET2_HEADERS.join('\t')];
  let last = null;
  importFlatRows.forEach(r => {
    if (r.parentMat !== last && last !== null) lines.push('\t'.repeat(SHEET2_HEADERS.length - 1));
    last = r.parentMat;
    lines.push([r.parentMat, r.matDesc, r.plant, '1', r.alt, '1000', r.component, r.compDesc, r.matType, '', r.qty, r.uom, ''].join('\t'));
  });
  navigator.clipboard.writeText(lines.join('\n'))
    .then(() => toast('Copied! Paste directly into Excel', 'ok'))
    .catch(() => { importDownloadCSV(); });
}

function importDownloadCSV() {
  if (!importFlatRows.length) return;
  const lines = [SHEET2_HEADERS.map(h=>`"${h}"`).join(',')];
  let last = null;
  importFlatRows.forEach(r => {
    if (r.parentMat !== last && last !== null) lines.push(','.repeat(SHEET2_HEADERS.length - 1));
    last = r.parentMat;
    lines.push([r.parentMat, r.matDesc, r.plant, '1', r.alt, '1000', r.component, r.compDesc, r.matType, '', r.qty, r.uom, '']
      .map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sheet2_bom_output.csv';
  a.click();
  toast('Downloaded sheet2_bom_output.csv', 'ok');
}

function clearImport() {
  document.getElementById('pasteArea').value = '';
  document.getElementById('importStats').classList.remove('visible');
  document.getElementById('importOutput').classList.remove('visible');
  document.getElementById('importTableBody').innerHTML = '';
  importFlatRows = [];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeGroupKey = null;

function renderEditor() {
  document.getElementById('editorEmpty').style.display = 'none';
  document.getElementById('editorContent').style.display = '';

  const nav = document.getElementById('groupNav');
  const container = document.getElementById('groupsContainer');
  nav.innerHTML = ''; container.innerHTML = '';

  const keys = [...editedGroups.keys()];
  document.getElementById('groupCount').textContent = keys.length+' groups';

  if (!activeGroupKey || !editedGroups.has(activeGroupKey)) {
    activeGroupKey = keys[0];
  }

  keys.forEach((key, i) => {
    const g = editedGroups.get(key);
    const hasChanges = groupHasChanges(key);

    // Nav pill
    const pill = document.createElement('button');
    pill.className = 'group-pill'+(key===activeGroupKey?' active':'')+(hasChanges?' has-changes':'');
    pill.title = g.matDesc;
    pill.textContent = key;
    pill.onclick = () => { activeGroupKey=key; renderEditor(); };
    nav.appendChild(pill);

    // Group section
    const div = document.createElement('div');
    div.className = 'bom-group'+(key===activeGroupKey?' active':'');
    div.id = 'grp-'+i;
    div.innerHTML = buildGroupHTML(key, g);
    container.appendChild(div);
  });
}

function buildGroupHTML(key, g) {
  const colHeaders = ['Component','Description','Mat Type','Qty','UOM','Base Qty','Plant','Alt','Actions'];
  const thHTML = colHeaders.map(h=>`<th>${h}</th>`).join('');

  let rowsHTML = g.rows.map((r,ri) => buildRowHTML(key, r, ri)).join('');

  return `
    <div class="group-header-row">
      <div>
        <div class="group-title">${esc(key)}</div>
        <div class="group-desc">${esc(g.matDesc)}</div>
      </div>
      <div class="group-meta">
        <span>${g.rows.filter(r=>!r._deleted).length} components</span>
        <span>${g.plant}</span>
      </div>
    </div>
    <table class="bom-tbl">
      <thead><tr>${thHTML}</tr></thead>
      <tbody id="tbody-${key}">${rowsHTML}</tbody>
    </table>
    <button class="add-row-btn" onclick="addRow('${key}')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add component row
    </button>
  `;
}

function buildRowHTML(groupKey, r, ri) {
  const isDeleted = r._deleted===true;
  const isAdded   = r._isNew===true;
  const origRow   = getOrigRow(groupKey, r.id);
  const isModified = !isAdded && !isDeleted && origRow && rowModified(r, origRow);

  let cls = '';
  if (isDeleted) cls = 'row-deleted';
  else if (isAdded) cls = 'row-added';
  else if (isModified) cls = 'row-modified';

  const typeSelect = `<select class="cell-select" onchange="cellChanged('${groupKey}','${r.id}','matType',this.value)" ${isDeleted?'disabled':''}>
    ${['ROH','HALB','FERT','ROH-SFG'].map(t=>`<option value="${t}" ${r.matType===t?'selected':''}>${t}</option>`).join('')}
  </select>`;

  // HALB rows: show child group navigation button
  // ROH rows: no children possible ‚Äî no button
  const isHalb = r.matType === 'HALB';
  const childKey = r.component; // the component number IS the parent key of its children
  const hasChildGroup = isHalb && editedGroups && editedGroups.has(childKey);

  let halbBtn = '';
  if (isHalb && !isDeleted) {
    if (hasChildGroup) {
      halbBtn = `<button class="row-btn goto-child" title="Go to child group: ${esc(childKey)}" onclick="goToChildGroup('${childKey}')">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        ${esc(childKey)}
      </button>`;
    } else {
      halbBtn = `<button class="row-btn goto-child missing" title="No child group found for ${esc(childKey)}" onclick="createChildGroup('${childKey}','${esc(r.compDesc)}')">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add children
      </button>`;
    }
  }

  const actionBtns = isDeleted
    ? `<div class="row-actions"><button class="row-btn restore" title="Restore" onclick="restoreRow('${groupKey}','${r.id}')">‚Ü©</button></div>`
    : `<div class="row-actions">
        ${halbBtn}
        <button class="row-btn del" title="Delete row" onclick="deleteRow('${groupKey}','${r.id}')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        </button>
      </div>`;

  function inp(field, val, w='90px') {
    const origVal = origRow ? origRow[field] : val;
    const changed = !isAdded && val !== origVal;
    return `<input class="cell-input${changed?' changed':''}" style="min-width:${w}" value="${esc(val)}" 
      oninput="cellChanged('${groupKey}','${r.id}','${field}',this.value)" 
      title="${changed?'Original: '+esc(origVal):''}"
      ${isDeleted?'disabled':''}>`;
  }

  return `<tr class="${cls}" id="row-${r.id}">
    <td>${inp('component', r.component, '130px')}</td>
    <td>${inp('compDesc', r.compDesc, '220px')}</td>
    <td>${typeSelect}</td>
    <td>${inp('qty', r.qty, '70px')}</td>
    <td>${inp('uom', r.uom, '55px')}</td>
    <td>${inp('baseQty', r.baseQty, '70px')}</td>
    <td>${inp('plant', g_plant(groupKey), '90px')}</td>
    <td>${inp('alt', g_alt(groupKey), '50px')}</td>
    <td>${actionBtns}</td>
  </tr>`;
}

function g_plant(key) { return editedGroups.get(key)?.plant||''; }
function g_alt(key)   { return editedGroups.get(key)?.alt||''; }

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CELL EDITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cellChanged(groupKey, rowId, field, value) {
  const g = editedGroups.get(groupKey);
  if (!g) return;
  const row = g.rows.find(r=>r.id===rowId);
  if (!row) return;
  row[field] = value;
  // Re-render just the row styling (lightweight)
  refreshRowStyle(groupKey, rowId);
  updateDiffBadge();
}

function refreshRowStyle(groupKey, rowId) {
  const g = editedGroups.get(groupKey);
  const r = g?.rows.find(r=>r.id===rowId);
  if (!r) return;
  const tr = document.getElementById('row-'+rowId);
  if (!tr) return;

  const isDeleted  = r._deleted===true;
  const isAdded    = r._isNew===true;
  const origRow    = getOrigRow(groupKey, r.id);
  const isModified = !isAdded && !isDeleted && origRow && rowModified(r, origRow);

  tr.className = isDeleted?'row-deleted':isAdded?'row-added':isModified?'row-modified':'';

  // Update changed highlights on inputs
  tr.querySelectorAll('.cell-input').forEach(inp => {
    const field = inp.getAttribute('oninput')?.match(/'(\w+)',this/)?.[1];
    if (field && origRow) {
      inp.classList.toggle('changed', !isAdded && inp.value !== (origRow[field]||''));
    }
  });
}

function deleteRow(groupKey, rowId) {
  const g = editedGroups.get(groupKey);
  const r = g?.rows.find(r=>r.id===rowId);
  if (!r) return;
  if (r._isNew) {
    g.rows = g.rows.filter(r=>r.id!==rowId);
    reRenderGroup(groupKey);
  } else {
    r._deleted = true;
    refreshRowStyle(groupKey, rowId);
    // Update action button
    const tr = document.getElementById('row-'+rowId);
    if (tr) {
      tr.querySelector('.row-actions').innerHTML = `<button class="row-btn restore" title="Restore" onclick="restoreRow('${groupKey}','${rowId}')">‚Ü©</button>`;
      tr.querySelectorAll('input,select').forEach(el=>el.disabled=true);
    }
  }
  updateGroupPill(groupKey);
  updateDiffBadge();
}

function restoreRow(groupKey, rowId) {
  const g = editedGroups.get(groupKey);
  const r = g?.rows.find(r=>r.id===rowId);
  if (!r) return;
  delete r._deleted;
  reRenderGroup(groupKey);
  updateGroupPill(groupKey);
  updateDiffBadge();
}

function addRow(groupKey) {
  const g = editedGroups.get(groupKey);
  if (!g) return;
  g.rows.push({ id:newId(), component:'', compDesc:'', matType:'ROH', qty:'1,000', uom:'NO', baseQty:'1,000', _isNew:true });
  reRenderGroup(groupKey);
  updateGroupPill(groupKey);
  updateDiffBadge();
}

function addNewGroup() {
  const key = prompt('Enter new parent Material number:');
  if (!key || !key.trim()) return;
  const k = key.trim().toUpperCase();
  if (editedGroups.has(k)) { toast('Group already exists','err'); return; }
  const desc = prompt('Material Description (optional):') || '';
  editedGroups.set(k, { matDesc:desc, plant:'5500/5600', alt:'1', rows:[], _isNew:true });
  activeGroupKey = k;
  renderEditor();
  toast('New group added: '+k,'ok');
}

function goToChildGroup(childKey) {
  if (!editedGroups.has(childKey)) { toast('Child group not found: '+childKey, 'err'); return; }
  activeGroupKey = childKey;
  renderEditor();
  // Scroll the pill into view
  setTimeout(() => {
    const pills = document.querySelectorAll('.group-pill');
    const keys = [...editedGroups.keys()];
    const idx = keys.indexOf(childKey);
    if (pills[idx]) pills[idx].scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
  }, 50);
}

function createChildGroup(childKey, childDesc) {
  if (editedGroups.has(childKey)) { goToChildGroup(childKey); return; }
  const g = editedGroups.values().next().value; // borrow plant/alt from first group
  editedGroups.set(childKey, {
    matDesc: childDesc || '',
    plant: g ? g.plant : '5500/5600',
    alt: g ? g.alt : '1',
    rows: [],
    _isNew: true
  });
  activeGroupKey = childKey;
  renderEditor();
  toast('Child group created: '+childKey, 'ok');
}

function reRenderGroup(groupKey) {
  const g = editedGroups.get(groupKey);
  if (!g) return;
  const keys = [...editedGroups.keys()];
  const i = keys.indexOf(groupKey);
  const div = document.getElementById('grp-'+i);
  if (div) div.innerHTML = buildGroupHTML(groupKey, g);
}

function updateGroupPill(groupKey) {
  const hasChanges = groupHasChanges(groupKey);
  const keys = [...editedGroups.keys()];
  const pills = document.querySelectorAll('.group-pill');
  const idx = keys.indexOf(groupKey);
  if (pills[idx]) {
    pills[idx].classList.toggle('has-changes', hasChanges);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGE DETECTION HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROW_FIELDS = ['component','compDesc','matType','qty','uom','baseQty'];

function getOrigRow(groupKey, rowId) {
  return originalGroups?.get(groupKey)?.rows.find(r=>r.id===rowId) || null;
}

function rowModified(edited, orig) {
  return ROW_FIELDS.some(f => (edited[f]||'') !== (orig[f]||''));
}

function groupHasChanges(key) {
  if (!originalGroups) return false;
  const eg = editedGroups.get(key);
  const og = originalGroups.get(key);
  if (!og) return true; // new group
  if (!eg) return false;
  for (const r of eg.rows) {
    if (r._isNew || r._deleted) return true;
    const o = og.rows.find(x=>x.id===r.id);
    if (!o || rowModified(r,o)) return true;
  }
  return false;
}

function countAllChanges() {
  if (!editedGroups || !originalGroups) return 0;
  let total = 0;
  editedGroups.forEach((eg,key) => {
    const og = originalGroups.get(key);
    if (!og) { total += eg.rows.length; return; }
    eg.rows.forEach(r => {
      if (r._isNew || r._deleted) { total++; return; }
      const o = og.rows.find(x=>x.id===r.id);
      if (!o || rowModified(r,o)) total++;
    });
    og.rows.forEach(r => { if (!eg.rows.find(x=>x.id===r.id)) total++; });
  });
  return total;
}

function updateDiffBadge() {
  const n = countAllChanges();
  const badge = document.getElementById('diffBadge');
  badge.style.display = n>0 ? '' : 'none';
  badge.textContent = n>99 ? '99+' : n;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIFF ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runDiff() {
  document.getElementById('diffEmpty').style.display = 'none';
  document.getElementById('diffContent').style.display = '';

  const allGroupKeys = new Set([...originalGroups.keys(), ...editedGroups.keys()]);
  let totalAdded=0, totalRemoved=0, totalModified=0, totalUnchanged=0;
  const groupDiffs = [];

  allGroupKeys.forEach(key => {
    const og = originalGroups.get(key);
    const eg = editedGroups.get(key);
    const diffRows = [];

    if (!og) {
      // Entirely new group
      (eg?.rows||[]).forEach(r => {
        diffRows.push({ type:'added', edited:r });
        totalAdded++;
      });
    } else if (!eg) {
      // Group deleted (shouldn't normally happen in this UI)
      og.rows.forEach(r => { diffRows.push({ type:'removed', orig:r }); totalRemoved++; });
    } else {
      // Compare rows
      eg.rows.forEach(r => {
        if (r._isNew) { diffRows.push({ type:'added', edited:r }); totalAdded++; return; }
        if (r._deleted) { diffRows.push({ type:'removed', orig: og.rows.find(x=>x.id===r.id)||r, edited:r }); totalRemoved++; return; }
        const o = og.rows.find(x=>x.id===r.id);
        if (!o) { diffRows.push({ type:'added', edited:r }); totalAdded++; return; }
        if (rowModified(r,o)) { diffRows.push({ type:'modified', orig:o, edited:r }); totalModified++; }
        else { diffRows.push({ type:'unchanged', orig:o, edited:r }); totalUnchanged++; }
      });
      // Check for rows in orig that aren't in edited (shouldn't happen if delete marks _deleted)
      og.rows.forEach(o => {
        if (!eg.rows.find(r=>r.id===o.id)) { diffRows.push({ type:'removed', orig:o }); totalRemoved++; }
      });
    }

    if (diffRows.length) {
      const g = eg||og;
      groupDiffs.push({ key, matDesc:g.matDesc, plant:g.plant, rows:diffRows, isNew:!og });
    }
  });

  // Summary
  const summary = document.getElementById('diffSummary');
  summary.innerHTML = `
    <div class="diff-stat"><div class="diff-stat-num green">${totalAdded}</div><div class="diff-stat-label">Rows Added</div></div>
    <div class="diff-stat"><div class="diff-stat-num red">${totalRemoved}</div><div class="diff-stat-label">Rows Removed</div></div>
    <div class="diff-stat"><div class="diff-stat-num amber">${totalModified}</div><div class="diff-stat-label">Rows Modified</div></div>
    <div class="diff-stat"><div class="diff-stat-num muted">${totalUnchanged}</div><div class="diff-stat-label">Unchanged</div></div>
  `;

  // Output
  const out = document.getElementById('diffOutput');
  out.innerHTML = '';

  if (totalAdded+totalRemoved+totalModified === 0) {
    out.innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><h3>No changes detected</h3><p>The edited BOM matches the original exactly.</p></div>`;
    return;
  }

  groupDiffs.forEach(gd => {
    const hasChange = gd.rows.some(r=>r.type!=='unchanged');
    if (!hasChange) return;

    const div = document.createElement('div');
    div.className = 'diff-group';

    const newBadge = gd.isNew ? `<span class="diff-tag diff-tag-added">NEW GROUP</span>` : '';
    div.innerHTML = `
      <div class="diff-group-title">
        <span>${esc(gd.key)}</span>
        <span style="font-weight:400; color:var(--text3)">${esc(gd.matDesc)}</span>
        ${newBadge}
      </div>
      <div class="diff-table-wrap">
        <table class="diff-tbl">
          <thead><tr>
            <th>Status</th>
            <th>Component</th>
            <th>Description</th>
            <th>Mat Type</th>
            <th>Qty</th>
            <th>UOM</th>
            <th>Base Qty</th>
          </tr></thead>
          <tbody>${gd.rows.filter(r=>r.type!=='unchanged').map(r=>buildDiffRow(r)).join('')}</tbody>
        </table>
      </div>
    `;
    out.appendChild(div);
  });
}

function buildDiffRow(r) {
  const typeMap = { added:'diff-added', removed:'diff-removed', modified:'diff-modified', unchanged:'diff-unchanged' };
  const tagMap  = { added:'diff-tag-added', removed:'diff-tag-removed', modified:'diff-tag-modified', unchanged:'diff-tag-unchanged' };
  const labelMap = { added:'+', removed:'‚àí', modified:'~', unchanged:'=' };

  const cls = typeMap[r.type];
  const tag = `<span class="diff-tag ${tagMap[r.type]}">${labelMap[r.type]}</span>`;

  function diffCell(field) {
    if (r.type==='added')   return esc(r.edited[field]);
    if (r.type==='removed') return `<span style="text-decoration:line-through;color:var(--red)">${esc(r.orig[field])}</span>`;
    if (r.type==='modified') {
      const ov = r.orig[field]||'', nv = r.edited[field]||'';
      if (ov!==nv) return `<span class="cell-old">${esc(ov)}</span><span class="cell-new">${esc(nv)}</span>`;
      return esc(nv);
    }
    return esc((r.edited||r.orig)[field]);
  }

  const row = r.edited||r.orig;
  return `<tr class="${cls}">
    <td>${tag}</td>
    <td>${diffCell('component')}</td>
    <td>${diffCell('compDesc')}</td>
    <td>${diffCell('matType')}</td>
    <td>${diffCell('qty')}</td>
    <td>${diffCell('uom')}</td>
    <td>${diffCell('baseQty')}</td>
  </tr>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT (from Editor tab ‚Äî exports edited BOM)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildExportRows() {
  const rows = [];
  editedGroups.forEach((g, key) => {
    const activeRows = g.rows.filter(r => !r._deleted);
    if (activeRows.length === 0) return;
    activeRows.forEach(r => {
      rows.push([key, g.matDesc, g.plant, '1', g.alt, '1000', r.component, r.compDesc, r.matType, '', r.qty, r.uom, '']);
    });
    rows.push(null); // blank separator
  });
  return rows;
}

function exportTSV() {
  const rows = buildExportRows();
  const lines = [SHEET2_HEADERS.join('\t')];
  rows.forEach(r => lines.push(r ? r.join('\t') : ''));
  navigator.clipboard.writeText(lines.join('\n')).then(()=>toast('Copied! Paste into Excel','ok')).catch(()=>{
    downloadText(lines.join('\n'), 'bom_sheet2.tsv', 'text/tab-separated-values');
  });
}

function exportDiffCSV() {
  if (!editedGroups || !originalGroups) { toast('No data','err'); return; }
  const lines = ['Status,Group,Material Description,Component,Component Description,Mat Type,Qty,UOM,Base Qty'];
  const allKeys = new Set([...originalGroups.keys(), ...editedGroups.keys()]);

  allKeys.forEach(key => {
    const og = originalGroups.get(key);
    const eg = editedGroups.get(key);
    const g = eg||og;

    const processRow = (r, type) => {
      const row = r.edited||r.orig||r;
      lines.push([type, key, g.matDesc, row.component, row.compDesc, row.matType, row.qty, row.uom, row.baseQty].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
    };

    (eg?.rows||[]).forEach(r => {
      if (r._isNew) processRow({edited:r},'ADDED');
      else if (r._deleted) processRow({orig: og?.rows.find(x=>x.id===r.id)||r},'REMOVED');
      else {
        const o = og?.rows.find(x=>x.id===r.id);
        if (!o) processRow({edited:r},'ADDED');
        else if (rowModified(r,o)) {
          // one row each for before/after
          lines.push(['MODIFIED_OLD', key, g.matDesc, o.component, o.compDesc, o.matType, o.qty, o.uom, o.baseQty].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
          lines.push(['MODIFIED_NEW', key, g.matDesc, r.component, r.compDesc, r.matType, r.qty, r.uom, r.baseQty].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
        }
      }
    });
  });

  downloadText(lines.join('\n'), 'bom_diff.csv', 'text/csv');
}

function exportExcel() {
  if (!editedGroups || !originalGroups) { toast('No data to export','err'); return; }

  const wb = XLSX.utils.book_new();

  // ‚îÄ‚îÄ SHEET 1: Edited BOM (Sheet 2 format) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const bomHeaders = ['Material','Material Description','Plant','Usage','Alternative',
    'Base quantity','Component','Component Description','Material Type',
    'Alt Text','Quantity','Component unit','Prod. Stor.Loc.'];

  const bomRows = [bomHeaders];
  let lastBomParent = null;

  editedGroups.forEach((g, key) => {
    const activeRows = g.rows.filter(r => !r._deleted);
    if (!activeRows.length) return;
    // blank separator row between groups (except first)
    if (lastBomParent !== null) bomRows.push(new Array(bomHeaders.length).fill(''));
    lastBomParent = key;
    activeRows.forEach(r => {
      bomRows.push([key, g.matDesc, g.plant, 1, g.alt, 1000,
        r.component, r.compDesc, r.matType, '', r.qty, r.uom, '']);
    });
  });

  const wsNew = XLSX.utils.aoa_to_sheet(bomRows);

  // Column widths for BOM sheet
  wsNew['!cols'] = [
    {wch:18},{wch:42},{wch:12},{wch:7},{wch:11},{wch:10},
    {wch:18},{wch:42},{wch:12},{wch:9},{wch:10},{wch:14},{wch:14}
  ];

  // Style header row bold + background
  const bomRange = XLSX.utils.decode_range(wsNew['!ref']);
  for (let C = bomRange.s.c; C <= bomRange.e.c; C++) {
    const cell = wsNew[XLSX.utils.encode_cell({r:0, c:C})];
    if (cell) {
      cell.s = {
        font: { bold: true, color: { rgb: 'FFFFFF' } },
        fill: { fgColor: { rgb: '2563A8' } },
        alignment: { horizontal: 'center' }
      };
    }
  }

  XLSX.utils.book_append_sheet(wb, wsNew, 'New BOM');

  // ‚îÄ‚îÄ SHEET 2: Diff ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const diffHeaders = ['Status','Group (Parent)','Material Description',
    'Component','Component Description','Mat Type',
    'Qty (Original)','Qty (New)','UOM (Original)','UOM (New)',
    'Base Qty (Original)','Base Qty (New)'];

  const diffRows = [diffHeaders];

  const allKeys = new Set([...originalGroups.keys(), ...editedGroups.keys()]);

  allKeys.forEach(key => {
    const og = originalGroups.get(key);
    const eg = editedGroups.get(key);
    const grp = eg || og;

    if (!og) {
      // New group ‚Äî all rows added
      (eg?.rows || []).forEach(r => {
        diffRows.push(['ADDED', key, grp.matDesc,
          r.component, r.compDesc, r.matType,
          '', r.qty, '', r.uom, '', r.baseQty]);
      });
      return;
    }

    (eg?.rows || []).forEach(r => {
      if (r._isNew) {
        diffRows.push(['ADDED', key, grp.matDesc,
          r.component, r.compDesc, r.matType,
          '', r.qty, '', r.uom, '', r.baseQty]);
        return;
      }
      if (r._deleted) {
        const o = og.rows.find(x => x.id === r.id) || r;
        diffRows.push(['REMOVED', key, grp.matDesc,
          o.component, o.compDesc, o.matType,
          o.qty, '', o.uom, '', o.baseQty, '']);
        return;
      }
      const o = og.rows.find(x => x.id === r.id);
      if (!o) {
        diffRows.push(['ADDED', key, grp.matDesc,
          r.component, r.compDesc, r.matType,
          '', r.qty, '', r.uom, '', r.baseQty]);
        return;
      }
      if (rowModified(r, o)) {
        diffRows.push(['MODIFIED', key, grp.matDesc,
          r.component, r.compDesc,
          o.matType === r.matType ? r.matType : `${o.matType} ‚Üí ${r.matType}`,
          o.qty, r.qty, o.uom, r.uom, o.baseQty, r.baseQty]);
      } else {
        diffRows.push(['UNCHANGED', key, grp.matDesc,
          r.component, r.compDesc, r.matType,
          r.qty, r.qty, r.uom, r.uom, r.baseQty, r.baseQty]);
      }
    });
  });

  const wsDiff = XLSX.utils.aoa_to_sheet(diffRows);

  // Column widths for diff sheet
  wsDiff['!cols'] = [
    {wch:11},{wch:18},{wch:38},{wch:18},{wch:38},
    {wch:10},{wch:14},{wch:14},{wch:12},{wch:12},{wch:14},{wch:14}
  ];

  // Style header row
  const diffRange = XLSX.utils.decode_range(wsDiff['!ref']);
  for (let C = diffRange.s.c; C <= diffRange.e.c; C++) {
    const cell = wsDiff[XLSX.utils.encode_cell({r:0, c:C})];
    if (cell) {
      cell.s = {
        font: { bold: true, color: { rgb: 'FFFFFF' } },
        fill: { fgColor: { rgb: '374151' } },
        alignment: { horizontal: 'center' }
      };
    }
  }

  // Color-code status column rows in diff sheet
  const statusColors = {
    'ADDED':     { bg: 'DCFCE7', fg: '166534' },
    'REMOVED':   { bg: 'FEE2E2', fg: '991B1B' },
    'MODIFIED':  { bg: 'FEF9C3', fg: '92400E' },
    'UNCHANGED': { bg: 'F9FAFB', fg: '6B7280' },
  };

  for (let R = 1; R <= diffRange.e.r; R++) {
    const statusCell = wsDiff[XLSX.utils.encode_cell({r:R, c:0})];
    if (!statusCell) continue;
    const status = statusCell.v;
    const colors = statusColors[status];
    if (!colors) continue;
    statusCell.s = {
      font: { bold: true, color: { rgb: colors.fg } },
      fill: { fgColor: { rgb: colors.bg } },
      alignment: { horizontal: 'center' }
    };
    // Light background on the rest of the row
    for (let C = 1; C <= diffRange.e.c; C++) {
      const c = wsDiff[XLSX.utils.encode_cell({r:R, c:C})];
      if (c) c.s = { fill: { fgColor: { rgb: colors.bg } } };
    }
  }

  XLSX.utils.book_append_sheet(wb, wsDiff, 'Changes (Diff)');

  // ‚îÄ‚îÄ Write and download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Generate filename with timestamp
  const now = new Date();
  const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
  const filename = `BOM_Export_${ts}.xlsx`;

  XLSX.writeFile(wb, filename, { bookType: 'xlsx', type: 'binary', cellStyles: true });
  toast(`Downloaded ${filename}`, 'ok');
}

function downloadText(text, filename, mime) {
  const blob = new Blob([text], { type: mime });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  toast('Downloaded: '+filename,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

  if (page==='diff' && editedGroups && originalGroups) runDiff();
}

function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show '+(type==='ok'?'ok':'err');
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.className=''; }, 2800);
}
</script>
</body>
</html>
